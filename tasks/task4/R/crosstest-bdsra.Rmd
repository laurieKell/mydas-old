---
title: "Cross test using Operating Model based on Life History"
subtitle: "Biomass Dynamic and Stock Reduction Analysis"
author: "L Kell"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
vignette: >
  %\VignetteIndexEntry{FLife}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
github_document:
    mathjax: TRUE
tags: FLife
license: Creative Commons Attribution-ShareAlike 4.0 International Public License
---

```{r knitr_init, echo=FALSE, results="hide"}
library(knitr)
## Global options
opts_chunk$set(cache     =TRUE,
               cache.path="../cache/crosstest/bd/",
               echo      =FALSE,
               eval      =TRUE,
               prompt    =FALSE,
               comment   =NA,
               message   =FALSE,
               warning   =FALSE,
               tidy      =TRUE,
               fig.height=10,
               fig.width =8,
               fig.path  ="../tex/crosstest-bd")

options(digits=3)

iFig=0
```
```{r pkgs}
library(ggplot2)
library(reshape)
library(plyr)
library(dplyr)
library(FLCore)
library(ggplotFL)

library(mpb)
```
```{r, dir}
dirMy ="/home/laurence/Desktop/sea++/mydas/papers/black-box"
dirDat=file.path(dirMy,"data")

load(file.path(dirDat,"plaice.RData"))

load(file.path(dirDat,"plaice.RData"))

om=omPlaice

bd=biodyn(window(om,start=25,end=75))

params(bd)["r"] =0.2 #mean(prior[c("r")])
params(bd)["b0"]=0.8 
params(bd)["k"] =1200
params(bd)["p"] =0.00000000001

u               =stock(bd,0.5)
setParams(bd)   =u
setControl(bd)  =params(bd)

bd              =fit(bd,u)

print(plot(as(list("MP"=bd,"OM"=biodyn(om)),"biodyns")))
```

**Figure `r iFig=iFig+1; iFig`,** Biomass dynamic

```{r, prod, fig.height=6,fig.width=8}
plotProduction(iter(bd,1))+
  geom_path(aes(stock,catch),data=model.frame(mcf(FLQuants(iter(bd,1),"stock"=stock,"catch"=catch))))
```

**Figure `r iFig=iFig+1; iFig`,** Biomass dynamic production function.

```{r, sra}
bd=biodyn(window(om,start=25,end=75))

params(bd)["r"] =0.2 #mean(prior[c("r")])
params(bd)["b0"]=0.8 
params(bd)["k"] =1200
params(bd)["p"] =0.00000000001

dpl =stock(bd,0.5)
dpl[]=NA
dpl[,c(1:5,dim(u)[2]-(4:0))]=c(rep(0.8,5),rep(0.5,5))

setParams(bd) =dpl
setControl(bd)=params(bd)
sra           =fit(bd,dpl)

print(plot(as(list("MP"=sra,"OM"=biodyn(om)),"biodyns")))
```

**Figure `r iFig=iFig+1; iFig`,** Stock Reduction Analysis


```{r, bd-fwd}
bd=biodyn(window(om,start=25))

params(bd)["r"] =0.2 #mean(prior[c("r")])
params(bd)["b0"]=0.8 
params(bd)["k"] =1200
params(bd)["p"] =0.00000000001

bdfwd=mlply(seq(75,50,-5),function(x) {
          hat=window(bd,            end=x)
          u  =window(stock(hat,0.5),end=x)
          
          params(hat)=params(hat)[1:4]
          setParams(hat)=u
          setControl(hat)=params(hat)
          hat=fit(hat,u)
          
          fwd(hat,catch=catch(bd)[,dim(u)[2]+0:10])})

bdfwd=as(bdfwd,"biodyns")
```

```{r}
plot(bdfwd)
```

**Figure `r iFig=iFig+1; iFig`,** Biomass dynamic

```{r, sra-fwd}
bd=biodyn(window(om,start=25))

params(bd)["r"] =0.2 #mean(prior[c("r")])
params(bd)["b0"]=0.8 
params(bd)["k"] =1200
params(bd)["p"] =0.00000000001

srafwd=mlply(seq(75,50,-5),function(x) {
          hat=window(bd,end=x)
          u  =window(stock(hat,0.5),end=x)
          u[]=NA
          u[,c(1:5,dim(u)[2]-4:0)]=c(rep(0.8,5),rep(mean(c(stock(hat)[,dim(u)[2]-0:4]/
                                                           stock(hat)[,1:5])),5))
          
          params(hat)=params(hat)[1:4]
          setParams(hat)=u
          setControl(hat)=params(hat)
          hat=fit(hat,u)
          
          fwd(hat,catch=catch(bd)[,dim(u)[2]+0:10])
          })

srafwd=as(srafwd,"biodyns")
```

```{r}
plot(srafwd)
```

**Figure `r iFig=iFig+1; iFig`,** Stock Reduction Analysis

\newpage
## Session Info

```{r}
sessionInfo()
```

## Software Versions

* `r version$version.string`
* FLCore: `r packageVersion('FLCore')`
* FLife:  `r packageVersion('FLife')`
* FLRP:  `r packageVersion('FLRP')`
* **Compiled**: `r date()`

## Author information

**Laurence KELL**. laurie@kell.es

# References {#References}

