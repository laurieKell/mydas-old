---
title: "MyDas Task 2"
subtitle: "Data rich stock assessments (i.e. Cat 1)" 
author: "Laurence Kell & Alex Tidd"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown:::pdf_document
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEncoding{UTF-8}
bibliography: /home/laurence/Desktop/sea++/cie/greySnapper/tex/refs.bib
tags: FLPKG FLR
license: Creative Commons Attribution-ShareAlike 4.0 International
---

```{r knitr, echo=FALSE, results="hide"}
library(knitr)
## Global options
opts_chunk$set(cache     =!TRUE,
               cache.path="../cache/task2-sa",
               echo      =FALSE,
               eval      =TRUE,
               prompt    =FALSE,
               comment   =NA,
               message   =FALSE,
               warning   =FALSE,
               tidy      =FALSE,
               fig.height=10,
               fig.width =8,
               fig.path  ="../tex/task2-sa-")

iFig=0
```
```{r, pkgs}
library(plyr)
library(dplyr)
library(reshape2)
library(ggplot2)

library(FLCore)
library(FLBRP)
library(ggplotFL)
library(diags)
library(FLife)

theme_set(theme_bw())
options(digits=3)
```
```{r dir}
dirMy=dirname(FLife:::getScriptPath())
#dirMy="/home/laurence/Desktop/sea++/mydas/tasks/task2"

dirInp=file.path(FLCore:::getDir(FLCore:::getDir(dirMy)),"inputs")
dirDat=file.path(FLCore:::getDir(FLCore:::getDir(dirMy)),"data")
```

```{r, stocks}
nms=c("Cod North Sea", "Haddocki North Sea","Whiting North Sea","Saithe North Sea", 
      "Plaice North Sea", "Sole North Sea",
      "Cod Celtic Sea","Haddock Celtic Sea","Whiting Celtic Sea")
spp=c("Gadus morhua","Melanogrammus aeglefinus","Merlangius merlangus","Pollachius virens",
      "Pleuronectes platessa","Solea solea")
spp=spp[c(1:6,1:3)]
sea=c(rep("North Sea",6),rep("Celtic Sea",3))
stock=c("cod347","hadns","whg3747d","ple27420","solnsea","sains",
        "cod7ek","whg7bk","hadcs")
nms=data.frame(nms,spp,sea,stock)

load("/home/laurence/Desktop/sea++/stecf/data/stk.RData")
stk=stk["hadns"]

load("/home/laurence/Desktop/sea++/stecf/inputs/nsea/cod347/cod347_FLStockObject_wgnssk17_nscod17_ass06.RData")
stk["codns"]=cod

load("/home/laurence/Desktop/sea++/stecf/inputs/nsea/whg3747d/whg.27.47d.stock.Rdata")
stk["whgns"]=x.stock

load("/home/laurence/Desktop/sea++/stecf/inputs/nsea/ple27420/ple27.7d_stockobject.Rdata")
stk["plens"]=ass.stock

load("/home/laurence/Desktop/sea++/stecf/inputs/nsea/solns/sol-nsea_ass.stock_workspace.Rdata")
stk["solns"]=ass.stock

load("/home/laurence/Desktop/rfmo/ices/ns/2017/ple27420/ple.27.420_stock.object.Rdata")
stk["sains"]=ass.stock

load("/home/laurence/Desktop/rfmo/ices/cs/2017/cod7ek/xsa.stock.Rdata")
stock(xsa.stock)=computeStock(xsa.stock)
stk["codcs"]=xsa.stock

load("//home/laurence/Desktop/rfmo/ices/cs/2017/whg7bk/xsa.Rdata")
stk["whgcs"]=stock

load("/home/laurence/Desktop/rfmo/ices/cs/2017/colm/HAD_stock.RData")
stk["hadcs"]=stock

stk=llply(stk[c("codns","hadns","sains","whgns","plens","solns","codcs","hadcs","whgcs")],
                   function(x) iter(x,1))

save(stk,nms,file=file.path(dirDat,"stk.RData"),compress="xz")
```

```{r, indices}
load("/home/laurence/Desktop/rfmo/ices/ns/2017/ple27420/ple.27.420_stock.object.Rdata")
idxs=list("solns"=indices)

load("/home/laurence/Desktop/rfmo/ices/cs/2017/cod7ek/cod_idx.RData")
idxs["codcs"]=idx

load("/home/laurence/Desktop/rfmo/ices/cs/2017/colm/HAD_tunning.RData")
idxs["hadcs"]=tun

load("/home/laurence/Desktop/rfmo/ices/cs/2017/colm/PLE_tun.Rdata")
idxs["plecs"]=tun

load("/home/laurence/Desktop/rfmo/ices/cs/2017/sol7fg/INPUT/sol7fg_stock.Rdata")
idxs["solcs"]=tun

idxs=idxs[c("solns","codcs","hadcs","plecs","solcs")]
idx=idxs

save(idx,file=file.path(dirDat,"idx.RData"),compress="xz")
```

```{r, ts}
load(file.path(dirDat,"stk.RData"))

stkTs=ldply(stk,
          function(x) {
              x=iter(x,1)
      
              model.frame(FLQuants(
                ssb    =ssb( x),
                f      =fbar(x),
                catch  =catch(x),
                cpue   =catch(x)%/%fbar(x),
                recruit=rec(x),
                stock  =stock(x),
                hrate  =catch(x)%/%stock(x),
                pgwt   =stock.n(x)[ac(range(x)["plusgroup"])]%*%stock.wt(x)[ac(range(x)["plusgroup"])],
                pgn    =stock.n(x)[ac(range(x)["plusgroup"])],
                cmnwt  =FLQuant(aaply(catch.n(x)%*%catch.wt(x),2:6,sum))%/%
                            FLQuant(aaply(catch.n(x),2:6,sum)),
                smnwt  =FLQuant(aaply(stock.n(x)%*%stock.wt(x),2:6,sum))%/%
                            FLQuant(aaply(stock.n(x),2:6,sum)),
                cmnage =FLQuant(aaply(catch.n(x)%*%ages(catch.wt(x)),2:6,sum))%/%
                            FLQuant(aaply(catch.n(x),2:6,sum)),
                smnage =FLQuant(aaply(stock.n(x)%*%ages(stock.wt(x)),2:6,sum))%/%
                            FLQuant(aaply(stock.n(x),2:6,sum))
                ),drop=TRUE)})

save(stkTs,file=file.path(dirDat,"stkTs.RData"))
```

```{r, sa.org}
idxNs=list(mlply(c(
              "nscod_ass06_fc17",
	            "NS_saithe_corr_DATRASQ3_cw4sw_update",
	            "sam-tmb-01",
	            "sam-tmb-turbot-2017-01",
	            "sole20-24",
	            "sole2024_2018",
	            "sole2024_admb",
	            "sole3a2017",
	            "witch_2018_007",
	            "witch_2018_008"), function(x){ print(x)
	       readFLIndices(file.path("/home/laurence/Desktop/rfmo/ices/ns/2017/sa.org",x,"data/survey.dat"))}))
idxCs=list(mlply(c(  
          "CODGis"
          #"HADPia",
          #"meg_rock_2016"
          ), function(x){ print(x)
	     readFLIndices(file.path("/home/laurence/Desktop/rfmo/ices/cs/2017/sa.org",x,"data/survey.dat"))}))

nsIdx=ldply(idxNs, function(x) 
      ldply(x, function(y) 
      ldply(y, function(z) as.data.frame(index(z),drop=TRUE))))

bioNs=list(mdply(c("nsea-dab"), 
            function(x){ print(x)
	 read.csv(file.path("/home/laurence/Desktop/rfmo/ices/ns/2017/sa.org",x,"data/data.txt"),skip=1)}))

spictCs=c("meg_rock_2016",
          "Megrim_78_ADGWW2_IBP_update_Land",
          "Megrim_78_Cat_Porc_EVHO_Vigo1_2_IR1_ADGWW2",
          "Megrim_78_ADGWW2_IBP_update_Catch",
          "SPiCT-whg-iris",
          "nep_2021",
          "anb-78_ADGWW2",
          "anb_78",
          "anp_78PostADGWW2Correction",
          "ple-iris_ADGWW2")[-c(3:4,8)]
bioCs=mdply(spictCs, 
            function(x){ print(x)
      read.csv(file.path("/home/laurence/Desktop/rfmo/ices/cs/2017/sa.org",x,"data/data.txt"),skip=1)})
bioCs$stock=spictCs[bioCs$X1]
names(bioCs)=c("X1","year","yearEnd","fleet","obs","stock")
bioCs=bioCs[c(6,2:5)]

save(bioNs,bioCs,idxNs,idxCs,spictCs,file=file.path(dirDat,"saorg.RData"),compress="xz")
```

```{r, plot-ts-ssb}
ggplot(stkTs)+
  geom_line(aes(year,ssb))+
  guides(colour=guide_legend(title="Stock",title.position="left"))+
  xlab("Year")+ylab("SSB")+
  theme_bw()+
  theme(legend.position="bottom")+
  facet_wrap(~.id,scale="free_y",ncol=2)
```
**Figure `r iFig=iFig+1; iFig`** SSB

```{r, plot-ts-f}
ggplot(stkTs)+
  geom_line(aes(year,f))+
  guides(colour=guide_legend(title="Stock",title.position="left"))+
  xlab("Year")+ylab("F")+
  theme_bw()+
  theme(legend.position="bottom")+
  facet_wrap(~.id,scale="free_y",ncol=2)
```
**Figure `r iFig=iFig+1; iFig`** Fishing Mortality


```{r, plot-h}
ggplot(stkTs)+
  geom_line(aes(year,hrate))+
  guides(colour=guide_legend(title="Stock",title.position="left"))+
  xlab("Year")+ylab("Harvest Rate")+
  theme_bw()+
  theme(legend.position="bottom")+
  facet_wrap(~.id,scale="free_y",ncol=2)
```
**Figure `r iFig=iFig+1; iFig`** Harvest rate

```{r, plot-ts-y}
ggplot(stkTs)+
  geom_line(aes(year, catch))+
  guides(colour=guide_legend(title="Stock",title.position="left"))+
  xlab("Year")+ylab("Catch")+
  theme_bw()+
  theme(legend.position="bottom")+
  facet_wrap(~.id,scale="free_y",ncol=2)
```
**Figure `r iFig=iFig+1; iFig`** Yield

```{r, plot-ts-u}
ggplot(stkTs)+
  geom_line(aes(year,cpue))+
  guides(colour=guide_legend(title="Stock",title.position="left"))+
  xlab("Year")+ylab("CPUE")+
  theme_bw()+
  theme(legend.position="bottom")+
  facet_wrap(~.id,scale="free_y",ncol=2)
```
**Figure `r iFig=iFig+1; iFig`** CPUE

```{r, plot-ts-r}
ggplot(stkTs)+
  geom_line(aes(year,recruit))+
  guides(colour=guide_legend(title="Stock",title.position="left"))+
  xlab("Year")+ylab("Recruitment")+
  theme_bw()+
  theme(legend.position="bottom")+
  facet_wrap(~.id,scale="free_y",ncol=2)
```
**Figure `r iFig=iFig+1; iFig`** Recruitment

```{r, plot-b}
ggplot(stkTs)+
  geom_line(aes(year,stock))+
  guides(colour=guide_legend(title="Stock",title.position="left"))+
  xlab("Year")+ylab("Biomass")+
  theme_bw()+
  theme(legend.position="bottom")+
  facet_wrap(~.id,scale="free_y",ncol=2)
```
**Figure `r iFig=iFig+1; iFig`** Stock biomass.

```{r, plot-biocs1}
ggplot(ddply(subset(bioCs,fleet!=1),.(stock,fleet),transform, 
             obs=diags:::stdz(log(obs))))+
  geom_point(aes(year,obs,col=ac(fleet)))+
  geom_line(aes(year,obs,col=ac(fleet)))+
  xlab("Year")+ylab("CPUE")+
  facet_wrap(~stock,scale="free_y",ncol=2)
```
**Figure `r iFig=iFig+1; iFig`** CPUE

```{r, plot-biocs2}
ggplot(ddply(subset(bioCs,fleet==1),.(stock,fleet),transform, 
             obs=diags:::stdz(log(obs))))+
  geom_point(aes(year,obs,col=ac(fleet)))+
  geom_line(aes(year,obs,col=ac(fleet)))+
  xlab("Year")+ylab("biomass")+
  facet_wrap(~stock,scale="free_y",ncol=2)
```
**Figure `r iFig=iFig+1; iFig`** CPUE

\newpage
## Software Versions

* `r version$version.string`
* FLCore: `r packageVersion('FLCore')`
* FLife:  `r packageVersion('FLife')`
* FLBRP:   `r packageVersion('FLBRP')`
* **Compiled**: `r date()`

## Author information

**Laurence Kell**. laurie@seaplusplus.es

## Acknowledgements

This vignette and many of the methods documented in it were developed under the MyDas project funded by the Irish exchequer and EMFF 2014-2020. The overall aim of MyDas is to develop and test a range of assessment models and methods to establish Maximum Sustainable Yield (MSY) reference points (or proxy MSY reference points) across the spectrum of data-limited stocks.

# References {#References}
